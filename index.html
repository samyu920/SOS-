<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SOS Web â€” HTML/CSS/JS</title>
  <style>
    :root{--bg:#f6f8fa;--card:#fff;--accent:#2b6cb0;--danger:#c53030}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:#111}
    .wrap{max-width:820px;margin:20px auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between}
    h1{font-size:1.4rem;margin:0}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(16,24,40,0.05);margin-top:14px}
    label{display:block;font-size:0.85rem;color:#333;margin-bottom:6px}
    input[type=text], input[type=tel], input[type=number], .row input{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef8}
    button{cursor:pointer;border:0;padding:10px 12px;border-radius:8px}
    .primary{background:var(--accent);color:#fff}
    .danger{background:var(--danger);color:#fff;font-weight:700}
    .small{font-size:0.85rem;color:#555}
    .contacts{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .contact{display:flex;gap:8px;align-items:center}
    .contact input{flex:1}
    .contact button{padding:8px}
    .row{display:flex;gap:8px}
    .row>input{flex:1}
    footer{margin-top:18px;text-align:center;color:#666;font-size:0.85rem}
    @media (max-width:520px){.row{flex-direction:column}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>SOS Web</h1>
      <div class="small">Offline-ready UI â€¢ Stores login locally</div>
    </header>

    <div id="loginCard" class="card" style="display:none">
      <h3>Set up your account</h3>
      <div style="margin-top:8px">
        <label for="name">Full name</label>
        <input id="name" type="text" placeholder="Your name" />
      </div>
      <div style="margin-top:8px">
        <label for="phone">Your phone (E.164, e.g. +9198...)</label>
        <input id="phone" type="tel" placeholder="+countrycodexxxxxxxxx" />
      </div>
      <div style="margin-top:12px">
        <button id="saveAccount" class="primary">Save & Continue</button>
      </div>
    </div>

    <div id="mainApp" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div id="welcomeText"><strong>Hello</strong></div>
            <div class="small">Your number: <span id="yourPhone"></span></div>
          </div>
          <div>
            <button id="logoutBtn">Logout</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Emergency Contacts <span class="small">(min 3 recommended)</span></h3>
        <div class="contacts" id="contactsList"></div>
        <div class="row" style="margin-top:8px">
          <input id="newContactName" placeholder="Contact name" />
          <input id="newContactPhone" placeholder="+countrycode phone" />
        </div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="addContact" class="primary">Add Contact</button>
          <button id="exportContacts">Export</button>
        </div>
      </div>

      <div class="card">
        <h3>Send SOS</h3>
        <div class="small">When you press SOS the page will get your live location and try to send SMS to your saved contacts.</div>
        <div style="margin-top:12px">
          <button id="sosBtn" class="danger" style="width:100%;font-size:1.1rem;padding:14px">ðŸš¨ SOS â€” Send Location</button>
        </div>
        <div id="status" class="small" style="margin-top:10px;display:none"></div>
      </div>

      <div class="card small">
        <strong>Notes:</strong>
        <ul>
          <li>Front-end is pure HTML/CSS/JS. SMS sending requires a backend endpoint <code>/api/send-sos</code>.</li>
          <li>If backend unreachable, the app opens your device SMS composer as a fallback so you can send the message manually.</li>
        </ul>
      </div>
    </div>

    <footer>Built with plain HTML/CSS/JS</footer>
  </div>

  <script>
  const LS_USER = 'sos_web_user_v1'
  const LS_CONTACTS = 'sos_web_contacts_v1'

  const $ = id => document.getElementById(id)
  function loadUser(){ try{return JSON.parse(localStorage.getItem(LS_USER))}catch(e){return null} }
  function saveUser(u){ localStorage.setItem(LS_USER, JSON.stringify(u)) }
  function clearUser(){ localStorage.removeItem(LS_USER) }
  function loadContacts(){ try{return JSON.parse(localStorage.getItem(LS_CONTACTS))||[]}catch(e){return[]} }
  function saveContacts(c){ localStorage.setItem(LS_CONTACTS, JSON.stringify(c)) }

  function showLogin(show){ $('loginCard').style.display = show ? 'block':'none' }
  function showApp(show){ $('mainApp').style.display = show ? 'block':'none' }

  function renderContacts(){
    const list = $('contactsList'); list.innerHTML = ''
    const contacts = loadContacts()
    contacts.forEach((c, idx)=>{
      const div = document.createElement('div'); div.className = 'contact'
      div.innerHTML = `
        <input value="${c.name}" data-idx="${idx}" class="cname" />
        <input value="${c.phone}" data-idx="${idx}" class="cphone" />
        <button data-idx="${idx}" class="remove">Delete</button>`
      list.appendChild(div)
    })
    if(contacts.length===0){ list.innerHTML = '<div class="small">No contacts yet</div>' }
  }

  (function init(){
    const user = loadUser()
    if(user){ showLogin(false); showApp(true); $('welcomeText').innerHTML = '<strong>Hi, '+user.name+'</strong>'; $('yourPhone').textContent = user.phone; renderContacts() }
    else{ showLogin(true); showApp(false) }
  })()

  $('saveAccount').addEventListener('click', ()=>{
    const name = $('name').value.trim(); const phone = $('phone').value.trim()
    if(!name || !phone){ alert('Please enter name and phone'); return }
    saveUser({name,phone})
    $('welcomeText').innerHTML = '<strong>Hi, '+name+'</strong>'
    $('yourPhone').textContent = phone
    showLogin(false); showApp(true)
  })

  $('addContact').addEventListener('click', ()=>{
    const n = $('newContactName').value.trim(); const p = $('newContactPhone').value.trim()
    if(!n||!p){ alert('Provide contact name and phone'); return }
    const c = loadContacts(); c.push({name:n, phone:p}); saveContacts(c); $('newContactName').value=''; $('newContactPhone').value=''; renderContacts()
  })

  $('contactsList').addEventListener('click', (e)=>{
    const idx = e.target.dataset.idx
    if(!idx) return
    if(e.target.classList.contains('remove')){ const c=loadContacts(); c.splice(Number(idx),1); saveContacts(c); renderContacts(); }
  })
  $('contactsList').addEventListener('input', (e)=>{
    const idx = e.target.dataset.idx; if(idx==null) return
    const contacts = loadContacts();
    if(e.target.classList.contains('cname')) contacts[idx].name = e.target.value
    if(e.target.classList.contains('cphone')) contacts[idx].phone = e.target.value
    saveContacts(contacts)
  })

  $('logoutBtn').addEventListener('click', ()=>{ if(confirm('Logout and remove local account?')){ clearUser(); showLogin(true); showApp(false); } })

  $('exportContacts').addEventListener('click', ()=>{
    const c = loadContacts(); const blob = new Blob([JSON.stringify(c, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'contacts.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url)
  })

  $('sosBtn').addEventListener('click', ()=>{ sendSOS() })

  async function sendSOS(){
    const status = $('status'); status.style.display='block'; status.textContent = 'Acquiring location...'
    const contacts = loadContacts();
    if(contacts.length < 1){ alert('Add at least one contact (recommended 3)'); status.style.display='none'; return }

    if(!navigator.geolocation){ alert('Geolocation not supported'); status.style.display='none'; return }

    navigator.geolocation.getCurrentPosition(async (pos)=>{
      const lat = pos.coords.latitude; const lon = pos.coords.longitude; const user = loadUser()
      const payload = { user, coords: {lat,lon,accuracy:pos.coords.accuracy}, contacts }

      status.textContent = 'Sending to server...'
      try{
        const res = await fetch('/api/send-sos', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
        if(res.ok){ status.textContent = 'SOS sent to contacts âœ…' }
        else { status.textContent='Server error â€” using SMS fallback'; await smsFallback(user, lat, lon, contacts) }
      }catch(err){ status.textContent='Network error â€” opening SMS composer'; await smsFallback(user, lat, lon, contacts) }
    }, (err)=>{ alert('Could not get location: '+err.message); status.style.display='none' }, {enableHighAccuracy:true, timeout:10000})
  }

  async function smsFallback(user, lat, lon, contacts){
    const map = 'https://www.google.com/maps/search/?api=1&query='+lat+','+lon
    const msg = user.name+' ('+user.phone+') needs help! Location: '+map
    const to = contacts.slice(0,5).map(c=>c.phone).join(',')
    const href = 'sms:'+to+'?body='+encodeURIComponent(msg)
    window.open(href, '_blank')
    $('status').textContent = 'SMS composer opened. Please send the message.'
  }
  </script>
</body>
</html>
